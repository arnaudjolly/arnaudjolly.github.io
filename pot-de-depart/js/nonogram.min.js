var nonogram=function(a){'use strict';function b(a,b){return a.length===b.length&&a.every((a,c)=>a===b[c])}var c=Math.min,d={greyVeryLight:'#ccc',grey:'#555',greyVeryDark:'#111',blue:'#0ebeff',green:'#47cf73',violet:'#ae63e4',yellow:'#fcd000',red:'#ff3c41'};const f={EMPTY:0,FILLED:1,UNSET:2,TEMP_FILLED:3,TEMP_EMPTY:4,INCONSTANT:5};class e{constructor(){this.theme={filledColor:d.grey,unsetColor:d.greyVeryLight,correctColor:d.green,strokeColor:d.red,wrongColor:d.red,meshColor:d.yellow,isMeshed:!1,isBoldMeshOnly:!1,isMeshOnTop:!0,boldMeshGap:5}}initCanvas(a){let b=a instanceof HTMLCanvasElement?a:document.getElementById(a);b instanceof HTMLCanvasElement||(b=document.createElement('canvas')),this.canvas=b,this.canvas.nonogram&&this.canvas.nonogram.listeners.forEach(([a,b])=>{this.canvas.removeEventListener(a,b)}),this.canvas.nonogram=this,this.canvas.width=this.theme.width||this.canvas.clientWidth,this.canvas.height=this.canvas.width*(this.m+1)/(this.n+1),this.ctx=this.canvas.getContext('2d')||new CanvasRenderingContext2D,this.initListeners(),this.listeners.forEach(([a,b])=>{this.canvas.addEventListener(a,b)}),this.canvas.oncontextmenu=(a)=>{a.preventDefault()}}initListeners(){this.listeners=[]}removeNonPositiveHints(){function a(a,b,c){c[b]=a.filter((a)=>0<a)}this.hints.row.forEach(a),this.hints.column.forEach(a)}getSingleLine(a,b){const c=[];if('row'===a)for(let a=0;a<this.n;a+=1)c[a]=this.grid[b][a];else if('column'===a)for(let a=0;a<this.m;a+=1)c[a]=this.grid[a][b];return c}calculateHints(a,b){const c=[],d=this.getSingleLine(a,b);return d.reduce((a,b)=>{if(b===f.FILLED)c.push(a?c.pop()+1:1);else if(b!==f.EMPTY)throw new Error;return b===f.FILLED},!1),c}isLineCorrect(a,c){try{return b(this.calculateHints(a,c),this.hints[a][c])}catch(a){return!1}}getLocation(a,b){const c=this.canvas.getBoundingClientRect(),e=c.width,f=c.height,g=2*e/3,h=2*f/3,i=g/(this.n+1);return 0>a||a>=e||0>b||b>=f?'outside':0<=a&&a<=g&&0<=b&&b<h?i/2<=a&&a<g-i/2&&i/2<=b&&b<h-i/2?'grid':'limbo':g<=a&&a<e&&h<=b&&b<f?'controller':'hints'}print(){this.printGrid(),this.printHints(),this.printController()}printGrid(){const{ctx:a}=this,{width:b,height:c}=this.canvas,e=2*b/3/(this.n+1);a.clearRect(-1,-1,2*b/3+1,2*c/3+1),this.theme.isMeshed&&!this.theme.isMeshOnTop&&this.printMesh(),a.save(),a.translate(e/2,e/2);for(let b=0;b<this.m;b+=1)for(let c=0;c<this.n;c+=1)a.save(),a.translate(e*c,e*b),this.printCell(this.grid[b][c]),a.restore();a.restore(),this.theme.isMeshed&&this.theme.isMeshOnTop&&this.printMesh()}printCell(a){const{ctx:b}=this,c=2*this.canvas.width/3/(this.n+1);a===f.UNSET?(b.fillStyle=this.theme.unsetColor,b.fillRect(0.05*c,0.05*c,0.9*c,0.9*c)):a===f.FILLED?(b.fillStyle=this.theme.filledColor,b.fillRect(0.05*-c,0.05*-c,1.1*c,1.1*c)):void 0}printMesh(){const{ctx:a}=this,b=2*this.canvas.width/3/(this.n+1);a.save(),a.translate(b/2,b/2),a.beginPath();for(let c=1;c<this.m;c+=1)this.theme.isBoldMeshOnly||(a.moveTo(0,c*b),a.lineTo(this.n*b,c*b)),0==c%this.theme.boldMeshGap&&(a.moveTo(0,c*b),a.lineTo(this.n*b,c*b),!this.theme.isBoldMeshOnly&&(a.moveTo(0,c*b-1),a.lineTo(this.n*b,c*b-1),a.moveTo(0,c*b+1),a.lineTo(this.n*b,c*b+1)));for(let c=1;c<this.n;c+=1)this.theme.isBoldMeshOnly||(a.moveTo(c*b,0),a.lineTo(c*b,this.m*b)),0==c%this.theme.boldMeshGap&&(a.moveTo(c*b,0),a.lineTo(c*b,this.m*b),!this.theme.isBoldMeshOnly&&(a.moveTo(c*b-1,0),a.lineTo(c*b-1,this.m*b),a.moveTo(c*b+1,0),a.lineTo(c*b+1,this.m*b)));a.lineWidth=1,a.strokeStyle=this.theme.meshColor,a.stroke(),a.restore()}printHints(){const{ctx:a}=this,{width:b,height:c}=this.canvas,e=2*b/3/(this.n+1);a.clearRect(2*b/3-1,-1,3*b+1,2*c/3+1),a.clearRect(-1,2*c/3-1,2*b/3+1,c/3+1),a.save(),a.translate(e/2,e/2);for(let a=0;a<this.m;a+=1){for(let b=0;b<this.hints.row[a].length;b+=1)this.printSingleHint('row',a,b);0===this.hints.row[a].length&&this.printSingleHint('row',a,0)}for(let a=0;a<this.n;a+=1){for(let b=0;b<this.hints.column[a].length;b+=1)this.printSingleHint('column',a,b);0===this.hints.column[a].length&&this.printSingleHint('column',a,0)}a.restore()}printSingleHint(a,b,c){const{ctx:e}=this,{width:f,height:g}=this.canvas,h=2*f/3/(this.n+1);e.textAlign='center',e.textBaseline='middle',e.font=`${h}pt "Courier New", Inconsolata, Consolas, monospace`;const d=this.hints[a][b];e.fillStyle=d.isCorrect?this.theme.correctColor:this.theme.wrongColor,e.globalAlpha=!d.isCorrect&&d.unchanged?0.5:1,'row'===a?e.fillText(`${this.hints.row[b][c]||0}`,2*f/3+h*c,h*(b+0.5),0.8*h):'column'===a&&e.fillText(`${this.hints.column[b][c]||0}`,h*(b+0.5),2*g/3+h*c,0.8*h)}}return a.Game=class extends e{constructor(a,b,c,{theme:e={},onSuccess:g=()=>{},onAnimationEnd:h=()=>{}}={}){var k=Math.floor;super(),this.mousedown=(a)=>{const b=this.canvas.getBoundingClientRect(),c=a.clientX-b.left,e=a.clientY-b.top,g=2*b.width/3/(this.n+1),d=this.getLocation(c,e);if('controller'===d)this.switchBrush();else if('grid'===d){this.draw.firstI=k(e/g-0.5),this.draw.firstJ=k(c/g-0.5),this.draw.inverted=2===a.button;const b=this.grid[this.draw.firstI][this.draw.firstJ];let d=this.brush;this.draw.inverted&&(d=this.brush===f.FILLED?f.EMPTY:f.FILLED),(b===f.UNSET||d===b)&&(this.draw.mode=d===b?'empty':'filling',this.isPressed=!0,this.switchCell(this.draw.firstI,this.draw.firstJ)),this.draw.lastI=this.draw.firstI,this.draw.lastJ=this.draw.firstJ}},this.mousemove=(a)=>{if(this.isPressed){const b=this.canvas.getBoundingClientRect(),c=a.clientX-b.left,e=a.clientY-b.top,f=2*b.width/3/(this.n+1);if('grid'===this.getLocation(c,e)){const a=k(e/f-0.5),b=k(c/f-0.5);(a!==this.draw.lastI||b!==this.draw.lastJ)&&(void 0===this.draw.direction&&(a===this.draw.firstI?this.draw.direction='row':b===this.draw.firstJ&&(this.draw.direction='column')),('row'===this.draw.direction&&a===this.draw.firstI||'column'===this.draw.direction&&b===this.draw.firstJ)&&(this.switchCell(a,b),this.draw.lastI=a,this.draw.lastJ=b))}}},this.brushUp=()=>{delete this.isPressed,this.draw={}},this.theme.filledColor=d.blue,this.theme.wrongColor=d.grey,this.theme.strokeColor=d.red,this.theme.isMeshed=!0,Object.assign(this.theme,e),this.handleSuccess=g,this.handleAnimationEnd=h,this.hints={row:a.slice(),column:b.slice()},this.removeNonPositiveHints(),this.m=this.hints.row.length,this.n=this.hints.column.length,this.grid=Array(this.m);for(let d=0;d<this.m;d+=1)this.grid[d]=Array(this.n).fill(f.UNSET);this.hints.row.forEach((a,b)=>{a.isCorrect=this.isLineCorrect('row',b)}),this.hints.column.forEach((a,b)=>{a.isCorrect=this.isLineCorrect('column',b)}),this.initCanvas(c),this.brush=f.FILLED,this.draw={},this.print()}calculateHints(a,b){const c=[],d=this.getSingleLine(a,b);return d.reduce((a,b)=>(b===f.FILLED&&c.push(a?c.pop()+1:1),b===f.FILLED),!1),c}initListeners(){this.listeners=[['mousedown',this.mousedown],['mousemove',this.mousemove],['mouseup',this.brushUp],['mouseleave',this.brushUp]]}switchBrush(){this.brush=this.brush===f.EMPTY?f.FILLED:f.EMPTY,this.printController()}switchCell(a,b){let c=this.brush;if(this.draw.inverted&&(c=this.brush===f.FILLED?f.EMPTY:f.FILLED),c===f.FILLED&&this.grid[a][b]!==f.EMPTY){this.grid[a][b]='filling'===this.draw.mode?f.FILLED:f.UNSET,this.hints.row[a].isCorrect=this.isLineCorrect('row',a),this.hints.column[b].isCorrect=this.isLineCorrect('column',b),this.print();const c=this.hints.row.every((a)=>!!a.isCorrect)&&this.hints.column.every((a)=>!!a.isCorrect);c&&this.succeed()}else c===f.EMPTY&&this.grid[a][b]!==f.FILLED&&(this.grid[a][b]='filling'===this.draw.mode?f.EMPTY:f.UNSET,this.print())}printCell(a){const{ctx:b}=this,c=2*this.canvas.width/3/(this.n+1);a===f.FILLED?(b.fillStyle=this.theme.filledColor,b.fillRect(0.05*-c,0.05*-c,1.1*c,1.1*c)):a===f.EMPTY?(b.strokeStyle=this.theme.strokeColor,b.lineWidth=c/15,b.beginPath(),b.moveTo(0.3*c,0.3*c),b.lineTo(0.7*c,0.7*c),b.moveTo(0.3*c,0.7*c),b.lineTo(0.7*c,0.3*c),b.stroke()):void 0}printController(){function a(){d.save(),d.translate(j,0),d.fillStyle=this.theme.meshColor,d.fillRect(0,0,i,i),d.fillStyle=this.theme.filledColor,d.fillRect(k,k,l,l),d.restore()}function b(){d.save(),d.translate(0,j),d.fillStyle=this.theme.meshColor,d.fillRect(0,0,i,i),d.clearRect(k,k,l,l),d.strokeStyle=this.theme.strokeColor,d.lineWidth=k,d.beginPath(),d.moveTo(0.3*i,0.3*i),d.lineTo(0.7*i,0.7*i),d.moveTo(0.3*i,0.7*i),d.lineTo(0.7*i,0.3*i),d.stroke(),d.restore()}const{ctx:d}=this,{width:e,height:g}=this.canvas,h=c(e,g)/4,i=3*h/4,j=h/4,k=h/20,l=i-2*k;d.clearRect(2*e/3-1,2*g/3-1,e/3+1,g/3+1),d.save(),d.translate(0.7*e,0.7*g),this.brush===f.FILLED?(b.call(this),a.call(this)):this.brush===f.EMPTY&&(a.call(this),b.call(this)),d.restore()}succeed(){function a(a){return 1+Math.pow(a-1,3)}this.handleSuccess(),this.listeners.forEach(([a,b])=>{this.canvas.removeEventListener(a,b)});const{ctx:b}=this,{width:e,height:f}=this.canvas,g=c(e,f)/4,h=b.getImageData(0,0,e,f),i=function(){var a=Math.SQRT2;const b=2*g,e=b/10,f=document.createElement('canvas');f.width=b,f.height=b;const h=f.getContext('2d')||new CanvasRenderingContext2D;return h.translate(b/3,5*b/6),h.rotate(-Math.PI/4),h.fillStyle=d.green,h.fillRect(0,0,e,-b*a/3),h.fillRect(0,0,2*(b*a)/3,-e),f}();let j=0;const k=()=>{b.putImageData(h,0,0),j+=0.03,b.globalAlpha=a(j),b.clearRect(2*e/3,2*f/3,e/3,f/3),b.drawImage(i,0.7*e-(1-a(j))*g/2,0.7*f-(1-a(j))*g/2,(2-a(j))*g,(2-a(j))*g),1>=j?requestAnimationFrame(k):this.handleAnimationEnd()};k()}},a}({});